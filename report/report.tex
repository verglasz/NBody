%!TeX program = lualatex
\documentclass[a4paper, 11pt]{article}

\usepackage{fontspec}
\usepackage[english]{babel}
\usepackage{amsmath,amsfonts,amsthm}
\usepackage{setspace}
\usepackage{geometry}
\usepackage{rotating}
\usepackage{hyperref}
\usepackage{xcolor}
\usepackage{tcolorbox}
\usepackage{enumitem}
\usepackage{chngcntr}
\usepackage{booktabs}
\usepackage{multirow}
\usepackage{microtype}
\usepackage{titling}
\usepackage{titlesec}
\usepackage{background}
\usepackage{graphicx}
\usepackage{caption}
\usepackage{subcaption}
\usepackage{karnaugh-map}
\usepackage{siunitx}
\usepackage{tikz}

% ----- OPTION SETUP -----

\setmainfont{EB Garamond}
\setsansfont{Gill Sans MT Book}
\setmonofont{AnonymousPro}[Scale=MatchLowercase]
\setmathrm{EB Garamond}

\newfontfamily\notosym{Noto Sans Symbols2}

\geometry{left = 2cm, right = 2cm, top = 2.5cm, bottom = 2.5cm}
\newcommand\titlegeometry{\newgeometry{left = 5cm, right = 5cm, top = 5cm, bottom = 5cm}}

\setitemize{noitemsep, topsep=0pt, parsep=0pt, partopsep=0pt}

\titleformat*{\subsection}{\large\bfseries}
\counterwithin*{figure}{section}
\counterwithin*{table}{section}
\renewcommand{\thetable}{\arabic{section}.\arabic{table}}
\renewcommand{\thefigure}{\arabic{section}.\arabic{figure}}

% \newcommand*\module[1]{\clearpage \section{Module \arabic{section} {#1}}}

% \renewcommand{\thesection}{}
% \renewcommand{\thesubsection}{\arabic{section}.\arabic{subsection}}
% \makeatletter
% \def\@seccntformat#1{\csname #1ignore\expandafter\endcsname\csname the#1\endcsname\quad}
% \let\sectionignore\@gobbletwo
% \let\latex@numberline\numberline
% \def\numberline#1{\if\relax#1\relax\else\latex@numberline{#1}\fi}
% \makeatother

\usetikzlibrary{
    matrix,
    calc,
    automata,
    positioning,
}
\tikzset{
    between/.style args={#1 and #2}{
         at = ($(#1)!0.5!(#2)$)
    }
    cell/.style = {
        nodes = {
            rectangle,
            draw = black,
        },
    },
    vectormat/.style = {
        matrix of nodes,
        minimum height = 2.5em,
        minimum width = 2.5em,
        row sep = -\pgflinewidth,
        column sep = -\pgflinewidth,
    },
    node distance = 15pt,
    nodes in empty cells,
    text depth=0.5ex,
    text height=2ex,
}

\hypersetup{ %
    colorlinks = true,
    linkcolor = [RGB]{29, 120, 91},
    urlcolor = [RGB]{120, 29, 29},
}

\graphicspath{ {/home/verglasz/media/images/logos} }

% --------- UTILITY MACROS --------


\newcommand*\bigo[1]{\(\mathcal{O}\left(#1\right)\)}
\newcommand\bh{Barnes-Hut}
\newcommand\theomp{OpenMP}
\newcommand\posix{POSIX}
\newcommand*\versor[1]{\hat{#1}}
\newcommand\cfile{}
\newcommand\makefile{Makefile}

\newcommand\comment[1]{\relax}
\newcommand*\mailto[1]{\href{mailto:#1}{\nolinkurl{#1}}}

\definecolor{CodeBG}{RGB}{27,31,35}
\newtcbox\code[1][{}]{
    nobeforeafter,
    tcbox raise base,
    size=tight,
    colframe=CodeBG,
    fontupper=\ttfamily\small,
    arc=3pt,
    boxsep=2pt,
    left=1pt,
    right=1pt,
    opacityback=0.95,
    boxrule=0pt,
    opacityframe=0,
    #1
}
\newcommand*\omp[1]{\code{\#pragma omp #1}}

\newcommand*\fig[1]{figure~\ref{fig:#1}}
\newcommand*\eq[1]{equation~\ref{eq:#1}}
\newcommand*\tab[1]{table~\ref{tab:#1}}

\newcommand*\xor{\oplus}

\makeatletter
\newcommand*{\rn}[1]{\expandafter\@slowromancap\romannumeral #1@}
\newcommand*\currentx{\the\tikz@lastxsaved}
\newcommand*\currenty{\the\tikz@lastysaved}
\makeatother
\newcommand*\currentcoordinate{\currentx,\currenty}

\makeatletter
\def\vecmatrix (#1) #2 {
    \gdef\a@sep{\noexpand\a@sep}
    \gdef\my@cols{}
    \foreach \i in {0,...,#2} { \xdef\my@cols{\my@cols \i \a@sep} }
    \gdef\a@sep{ \& \\ }
    \matrix (#1) [
        below = of varname,
        vectormat,
        column 1/.style = {font = \ttfamily},
        column 2/.style = {cell},
        ampersand replacement = \&,
    ] {
        \my@cols
    }
}
\makeatother

% ----- CUSTOMIZATION -----

\newcommand*\kthmail{\mailto{lomanto@kth.se}}
\newcommand*\personalmail{\mailto{gv.lomanto@gmail.com}}
\newcommand*\firstname{V\kern-0.145em{}alerio}
\newcommand*\lastname{Lomanto}
\newcommand*\ddob{17}
\newcommand*\mmob{07}
\newcommand*\yyob{1995}
\newcommand*\pnlast{0174}

\newcommand*\thisyear{2021}
\newcommand*\thiscourse{Concurrent Programming}
\newcommand*\thisreport{\!}
\newcommand*\thisprogram{TCOMK}
\newcommand*\thisperiod{VT21}

\newcommand*\fullname{\firstname~~\lastname}
\makeatletter
\newcommand*\personnummer{\expandafter\@gobbletwo\yyob\mmob\ddob-\pnlast}
\makeatother
\newcommand*\isodob{\yyob--\mmob--\ddob}
\newcommand*\thedob{Date of birth: \isodob}
\newcommand*\thepn{Personnummer: \texttt{\personnummer{}}}
\newcommand*\themail{E-mail: \kthmail{}, \ \personalmail{} }

\newcommand*\thesubtitle{An efficient parallel gravitational N-body simulation}
\author{\fullname}
\title{\thiscourse{} \thisreport{} -- \thisprogram{} \thisperiod{}}
\date{\today}

\newcommand*\phylologo{ %
    \includegraphics[width = 0.95\paperwidth, height = \paperheight, keepaspectratio]{phylolines} %
}
\newcommand*\logo{\phylologo}

\backgroundsetup{
    pages=some,
    angle=0,
    scale=1,
    opacity=.1,
    position={current page.center},
    vshift=-6.5cm,
    color=black,
    contents={ \logo },
}

\newcommand*\undefbg{\backgroundsetup{pages=some,contents={}}}

\newenvironment{logotitlepage}
    { %
        \titlegeometry
        \begin{titlepage}
        \thispagestyle{empty}
        \BgThispage
        \begin{spacing}{2}
    }
    { %
        \end{spacing}
        \end{titlepage}
    }

\newcommand*\makemytitle{ %
    \begin{logotitlepage}
        \begin{center}
            \makebox[\textwidth][c]{\huge \thetitle}
			\par
			{\LARGE \thesubtitle}
            \par
            \thedate
        \end{center}

        \vfill

        \textsc{\theauthor} \par
        % \thedob \par
        \thepn \par
        \themail
    \end{logotitlepage}
    \restoregeometry
    \undefbg
}


% -------- DOCUMENT -------

\begin{document}

\makemytitle

\newpage

\begin{abstract}
	I implement a parallel gravitational N-body simulator using two algorithms:
	a precise and trivial \bigo{N^2} one and the \bh{} algorithm (an \bigo{n \log n} approximation).

	Both approaches are implemented with \theomp{} multithreading, and thus can also be compiled into
	single-treaded executables.

	Performance for the two algorithms in both single- and multi-threaded mode is recorded with a
	variety of different parameters and analyzed.
\end{abstract}

\section{Compilation and execution}

The software only relies on the C standard library and \theomp{}, and is compiled with (GNU) Make.
A \posix{} shell script is used to launch the different executables with different options repeatedly and record performance;
a Python script analizes the data and plots it.

\section{Algorithm}
The most straightforward way to implement a gravitational simulation is computing the net acceleration
on each object and using it to update its velocity, then using the objects' velocity to update their
position, with every such step representing an equal amount of time elapsed. This was the approach
taken in both implementations.

To calculate the net acceleration on each body, a na\"ive approach is to iterate through the full
list of bodies and sum up all their contributions to the total force, using Newton's law of
gravitaiton:
\[
	\vec{F}_{12} = -G \frac{m_1 m_2}{d_{12}^2} \versor{d}_{12}
\]
With this approach, every time step of the simulation has \bigo{N^2} time complexity,
where $N$ is the number of bodies. We implemented this in \code{quadratic.c}.

A more sophisticated algorithm is the \bh{} algorithm: at every time step, the bodies are inserted
as leaves in a tree (a quadtree for 2D simulations, or an octree for 3D ones) based on their spatial
positions; every internal node mantains data about the total mass of its descendant bodies (leaves)
and their center of mass. To then compute the gravitational acceleration on an object,
the tree is traversed from the root up to nodes whose center of mass
(i.e., the center of mass of the bodies contained in the corresponding subtree)
is ``sufficiently far'', descending until the leaves if necessary.

\section{Performance}

\appendix

\section{Makefile}
\makefile{}

\section{Source code}
\subsection{barneshut.c}
\cfile{barneshut.c}

\subsection{quadratic.c}
\cfile{quadratic.c}

\subsection{common.c}
\cfile{common.c}

\subsection{gravity.c}
\cfile{gravity.c}

\end{document}

